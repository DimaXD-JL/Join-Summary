<div
  class="shaddowBox"
  [class.closing]="isClosing"
  (click)="closeOverlay.emit()"
>
  <div class="task_card_wrapper" (click)="$event.stopPropagation()">
    <div class="task-container">
      <div class="header-task" [ngClass]="{ 'edit-mode': isEditing }">
        <div
          class="task-category"
          *ngIf="!isEditing"
          [ngStyle]="{ 'background-color': getCategoryColor(todo?.category) }"
        >
          <ng-container>
            <span>{{ todo?.category }}</span>
          </ng-container>
        </div>

        <div class="close" (click)="closeOverlay.emit()">
          <img src="/assets/icons/close.png" alt="close" />
        </div>
      </div>

      @if (!isEditing) {
        <span>{{ todo?.title }}</span>
      } @else {
        <input class="custom-input" [(ngModel)]="editedTodo.title" />
      }

      @if (!isEditing) {
        <span>{{ todo?.description }}</span>
      } @else {
        <input class="custom-input" [(ngModel)]="editedTodo.description" />
      }

      <div class="priority-date">
        <span>Due date:</span>
        @if (!isEditing) {
          <span>{{ todo?.dueDate }}</span>
        } @else {
          <input
        class="custom-input"
        type="date"
        [(ngModel)]="editedTodo.dueDate"
          />
        }
      </div>

      <div class="priority">
        <span>Priority:</span>
        <div class="priority-icon">
          <ng-template #editPriority>
            <div class="priority-buttons">
              <button type="button" class="priority-btn" data-priority="urgent">
                <span class="text">Urgent</span>
                <span class="icon"
                  ><img src="../../../assets/icons/prio_high.png" alt=""
                /></span>
              </button>
              <button type="button" class="priority-btn" data-priority="medium">
                <span class="text">Medium</span>
                <span class="icon"
                  ><img src="../../../assets/icons/prio_medium.png" alt=""
                /></span>
              </button>
              <button type="button" class="priority-btn" data-priority="low">
                <span class="text">Low</span>
                <span class="icon"
                  ><img src="../../../assets/icons/prio_low.png" alt=""
                /></span>
              </button>
            </div>
          </ng-template>
        </div>
      </div>

      @if (!isEditing) {
        <div class="assigned">
          <p>Assigned TO :</p>
          <div class="assigned-container">
            <ng-container *ngIf="selectedContacts.length > 0; else noContacts">
              <div *ngFor="let contact of selectedContacts" class="assigned-contact assignedNameAvatar">
                <div
                  class="avatar"
                  [ngStyle]="{ 'background-color': getAvatarColor(contact) }"
                >
                  {{ getInitials(contact.name) }}
                </div>
                <span>{{ contact.name }}</span>
              </div>
            </ng-container>
            <ng-template #noContacts>
              <span>No contacts assigned</span>
            </ng-template>
          </div>
        </div>
      } @else {
        <ng-container *ngTemplateOutlet="editPriority"></ng-container>
        <div class="assigned">
        </div>
      }

      <div class="form-container" *ngIf="isEditing">
        <label><p>Assigned to</p></label>
        <div class="dropdown">
          <button (click)="toggleDropdown()" class="dropdown-button">
            <span>Select contacts to assign</span>
            <img src="../../../assets/icons/arrow-dropdown-down.png" alt="" />
          </button>
          <div class="assign-container" [class.open]="dropdownOpen">
            <ul class="contact-list">
              @for (contact of contactList; track contact) {
              <label class="assignedStyle">
                <div
                  class="avatar"
                  [ngStyle]="{ 'background-color': getAvatarColor(contact) }"
                >
                  {{ getInitials(contact.name) }}
                </div>
                <div class="contactName">{{ contact.name }}</div>
                <div class="checkContact">
                  <input
                    type="checkbox"
                    [checked]="selectedContacts.includes(contact)"
                    (change)="toggleContactSelection(contact, $event)"
                    class="custom-input"
                  />
                </div>
              </label>
              }
            </ul>
          </div>
        </div>

        @if (selectedContacts.length > 0) {
        <div class="assignedStyleSelected">
          @for (contact of selectedContacts; track contact) {
          <label>
            <div
              class="avatar"
              [ngStyle]="{ 'background-color': getAvatarColor(contact) }"
            >
              {{ getInitials(contact.name) }}
            </div>
            {{ contact.name }}
          </label>
          }
        </div>
        }
      </div>

      <div class="subtasks">
        <span>Subtasks</span>
        <div class="subtask-container">
          <ng-container *ngIf="!isEditing; else editSubtasks">
            <div class="subtask-entry" *ngFor="let st of todo?.subtasks">
              <input type="checkbox" [(ngModel)]="st.done" />
              <span>{{ st.title }}</span>
            </div>
          </ng-container>

          <ng-template #editSubtasks>
            <div *ngFor="let st of editedTodo.subtasks">
              <input type="checkbox" [(ngModel)]="st.done" />
              <input [(ngModel)]="st.title" />
            </div>
          </ng-template>
        </div>
      </div>

      <div class="delete-edit-container">
        <div class="deleteIcon" *ngIf="!isEditing">
          <img
            class="delete-icon"
            src="/assets/icons/delete.png"
            alt="delete-icon"
          />
          <span class="contact-link" (click)="deleteTodo()">Delete</span>
        </div>
        <hr *ngIf="!isEditing" />
        <div class="editIcon">
            @if (!isEditing) {
            <img
              class="edit-icon"
              src="/assets/icons/edit.png"
              alt="edit-icon"
              (click)="editTodo()"
            />
            <span class="contact-link" (click)="editTodo()">Edit</span>
            } @else {
            <ng-container *ngTemplateOutlet="saveButton"></ng-container>
            }
          <ng-template #saveButton>
            <div>
              <button class="check-task-btn" (click)="saveTodo()">
                Ok
                <img src="/assets/icons/check.png" alt="check-contact-button" />
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
